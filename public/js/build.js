/* author: carl, date: Thu Feb 09 2012 16:24:49 GMT+0800 (CST) */Ext.Loader.setConfig({enabled:!0});Ext.require("Ext.grid.*,Ext.tree.*,Ext.data.*,Ext.panel.*,Ext.selection.CheckboxModel,Ext.toolbar.TextItem,Ext.layout.container.Border".split(","));
Ext.onReady(function(){function m(a){return a.replace(/(^\s*)|(\s*$)/g,"")}function h(a){var c=a.action,b=a.filePath,e=a.success,d=a.failure;if(0===b){var a=i.selected,f,b=[];for(f=0;f<a.length;f++)b.push(a.get(f).get("Path"))}a="正在进行"+c+("[object Array]"===Object.prototype.toString.call(b)&&3<b.length?"，文件较多，请耐心等待...":", 请稍等...");f="build"===c?"build":["circle","spinner","pacman"][Math.floor(3*Math.random())];var n=Ext.create("Ext.window.MessageBox",{html:'<img style="width:64px;height:64px;margin:0px auto;display:block" src="/skin/imgs/loaders/'+
f+'.gif"/>'});n.show({width:300,msg:a});Ext.Ajax.request({method:"POST",url:"/buildfile",params:{action:c,filePath:b},timeout:18E5,callback:function(a,b,c){n.destroy();var f=Ext.create("Ext.window.Window",{title:"构建结果",layout:{type:"auto",align:"center"},minHeight:100,minWidth:300,maxHeight:600,maxWidth:800,items:[{xtype:"component",style:{background:"#f0f0ff",padding:"10px",maxWidth:"750px",maxHeight:"600px"},autoScroll:!0,html:c.responseText},{xtype:"button",text:"OK",width:100,height:25,handler:function(){f.destroy()}}]}).show();
b?"function"===typeof e&&b(c.responseText):"function"===typeof d&&failure(c.responseText)}})}function r(a,c){var b=i.selected,e,d=[];for(e=0;e<b.length;e++)d.push(b.get(e).get("Path"));var b=["circle","spinner","pacman"][Math.floor(3*Math.random())],f=Ext.create("Ext.window.MessageBox",{html:'<img style="width:64px;height:64px;margin:0px auto;display:block" src="/skin/imgs/loaders/'+b+'.gif"/>'});f.show({width:300,msg:"正在更新版本号，请稍等..."});Ext.Ajax.request({method:"POST",url:"/updateversion",params:{filePaths:d,
updatePath:a,versionString:c},callback:function(a,b,c){f.destroy();var d=Ext.create("Ext.window.Window",{title:"更新结果",layout:{type:"auto",align:"center"},minHeight:100,minWidth:300,maxHeight:600,maxWidth:800,items:[{xtype:"component",style:{background:"#f0f0ff",padding:"10px",maxWidth:"750px",maxHeight:"600px"},autoScroll:!0,html:c.responseText},{xtype:"button",text:"OK",width:100,height:25,handler:function(){d.destroy()}}]}).show()}})}function o(a){g.clearFilter(!0);var c=g.data.items,b,e=[],d;for(b=
-1;d=c[++b];)e.push(d.get("Path"));Ext.Ajax.request({method:"POST",url:"/filter",params:{query:a,filePath:e},callback:function(a,b,c){var d=JSON.parse(c.responseText);b&&"[object Array]"===Object.prototype.toString.call(d)?(g.filterBy(function(a){return-1<d.indexOf(a.get("Path"))?!0:!1}),i.selectAll()):Ext.Msg.alert("过滤请求失败")}})}function p(a){g.clearFilter(!0);var c=a.split(/\s+/),b,e;g.filterBy(function(a){a=a.get("Path");for(b=-1;e=c[++b];)if(!RegExp(e,"i").test(a))return!1;return!0});i.selectAll()}
window.USER_HAD_INPUT=!1;if("function"!==typeof Array.prototype.indexOf)Array.prototype.indexOf=function(a){var c,b;for(c=-1;b=this[++c];)if(a===b)return c;return-1};if("object"!==typeof console)console={log:function(){}};else if("function"!==typeof console.log)console.log=function(){};Ext.tip.QuickTipManager.init();Ext.Ajax.timeout=18E5;var q=Ext.create("Ext.data.TreeStore",{proxy:{type:"ajax",url:"/getfiletree",reader:{type:"json"}},fields:["text","LastModified"],root:{text:"src",expanded:!0},storeId:"fileTreeStore"}),
j=Ext.create("Ext.tree.Panel",{itemId:"fileTree",region:"west",store:q,title:"文件列表",width:"20%",split:!0,rootVisible:!0,autoScroll:!0});j.on("checkchange",function(a,c){window.USER_HAD_INPUT=!0;c&&a.expand();a.cascadeBy(function(a){a.set("checked",c)});var b=j.getView().getChecked(),e=[];Ext.Array.each(b,function(a){if(a.get("leaf")){for(var b=[],c=a;null!==c.parentNode;)b.push(c.get("text")),c=c.parentNode;a={Name:a.get("text"),LastModified:a.get("LastModified"),Path:b.reverse().join("/")};a.Status=
null!=window.hgStatus&&null!=window.hgStatus[a.Path]?window.hgStatus[a.Path]:"";e.push(a)}});g.removeAll();g.add(e);i.selectAll()},j);j.on("itemclick",function(a,c,b,e,d){null===d.getTarget("input")&&(a=!c.get("checked"),c.set("checked",a),j.fireEvent("checkchange",c,a))});var g=Ext.create("Ext.data.Store",{storeId:"FileStore",fields:["Name","LastModified","Path","Status"]}),i=Ext.create("Ext.selection.CheckboxModel",{mode:"SIMPLE",listeners:{selectionchange:function(a,c){window.USER_HAD_INPUT=!0;
var b=0==c.length;l.down("#buildButton").setDisabled(b);l.down("#updateVersionButton").setDisabled(b);l.down("#proxyButton").setDisabled(b);l.down("#importButton").setDisabled(b)}}}),k=Ext.create("Ext.window.Window",{frame:!1,title:"更新版本号需要的参数",layout:"anchor",width:500,items:[{xtype:"fieldcontainer",fieldLabel:"目录",labelAlign:"right",labelWidth:65,layout:"hbox",margin:"10 5 5 5",items:[{xtype:"textfield",value:"/nutshell/templates/",id:"updatePath",name:"updatePath",hideLabel:!0,width:160,allowBlank:!1},
{xtype:"splitter"},{xtype:"label",text:'需更新版本号的目录的绝对路径.请在行首补上guokr主目录的路径(支持"~")',flex:1}]},{xtype:"fieldcontainer",fieldLabel:"版本号",labelAlign:"right",labelWidth:65,margin:"10 5 5 5",layout:"hbox",items:[{xtype:"textfield",value:"",id:"versionString",name:"versionString",blankText:"请填写新的版本号",hideLabel:!0,width:160,allowBlank:!1},{xtype:"splitter"},{xtype:"label",text:"修改后的新版本号",flex:1}]}],dockedItems:[{xtype:"container",dock:"bottom",width:300,padding:"10 10 5",layout:{type:"hbox",align:"middle"},
items:[{xtype:"button",text:"OK",width:100,height:25,handler:function(){k.hide();var a=k.down("#updatePath").value,c=k.down("#versionString").value;r(a,c)}},{xtype:"button",text:"Cancel",width:100,margin:"0 0 0 10",height:25,handler:function(){k.hide()}}]}]}),l=Ext.create("Ext.grid.Panel",{store:g,itemId:"gridPanel",region:"center",height:420,autoScroll:!0,split:!0,title:"工作面板",selModel:i,columnLines:!0,viewConfig:{getRowClass:function(a){return a.get("Status")?"x-grid-row-with-status":""}},columns:[{text:"文件名",
width:150,dataIndex:"Name",sortable:!0},{text:"文件路径",width:320,dataIndex:"Path",sortable:!0},{text:"状态",width:42,dataIndex:"Status",sortable:!0},{text:"最后修改时间",width:150,xtype:"datecolumn",format:"Y-m-d H:i:s",dataIndex:"LastModified",sortable:!0},{xtype:"actioncolumn",header:"操作",flex:!0,items:[{icon:"/skin/imgs/icons/build.png",tooltip:"构建",getClass:function(){return"x-grid-icon"},handler:function(a,c){var b=a.getStore().getAt(c);h({action:"build",filePath:b.get("Path")})}},{icon:"/skin/imgs/icons/import.png",
tooltip:"合并",getClass:function(){return"x-grid-icon"},handler:function(a,c){var b=a.getStore().getAt(c);h({action:"import",filePath:b.get("Path")})}},{icon:"/skin/imgs/icons/connect.png",tooltip:"代理",getClass:function(){return"x-grid-icon"},handler:function(a,c){var b=a.getStore().getAt(c);h({action:"proxy",filePath:b.get("Path")})}},{icon:"/skin/imgs/icons/dependency.png",tooltip:"显示依赖图",getClass:function(){return"x-grid-icon"},handler:function(a,c){var b=a.getStore().getAt(c);h({action:"getDependency",
filePath:b.get("Path")})}}]}],dockedItems:[{xtype:"toolbar",items:[{text:"构建",xtype:"button",itemId:"buildButton",tooltip:"构建选中文件、文件夹",minWidth:75,disabled:!0,listeners:{click:function(){h({action:"build",filePath:0})}}},"-",{text:"合并",xtype:"button",itemId:"importButton",tooltip:"import选中文件、文件夹",minWidth:75,disabled:!0,listeners:{click:function(){h({action:"import",filePath:0})}}},"-",{text:"更新版本号",xtype:"button",itemId:"updateVersionButton",tooltip:"更新所有引用到被选中文件的引用版本号",minWidth:105,disabled:!0,
listeners:{click:function(){k.show(null,function(){setTimeout(function(){k.down("#updatePath").focus()},100)})}}},"-",{text:"代理",xtype:"button",itemId:"proxyButton",tooltip:"代理选中文件、文件夹",minWidth:75,disabled:!0,listeners:{click:function(){h({action:"proxy",filePath:0})}}}," ",{text:"取消所有代理",xtype:"button",itemId:"cancelProxyBtton",tooltip:"取消所有以前代理过的文件代理",minWidth:110,listeners:{click:function(){h({action:"cancelAllProxy",filePath:0,success:function(a){console.log("data:"+a)}})}}},"->",{xtype:"textfield",
name:"filterQuery",width:200,enableKeyEvents:!0,listeners:{keydown:function(a,c){var b=m(Ext.select("input[name=filterQuery]").first().dom.value);c.getCharCode()===c.ENTER&&(0!==b.indexOf("hg:")?p(b):o(b))}},emptyText:"输入过滤条件"},{xtype:"button",itemId:"filterButton",width:60,text:"过滤",listeners:{click:function(){var a=m(Ext.select("input[name=filterQuery]").first().dom.value);0!==a.indexOf("hg:")?p(a):o(a)}}}]}]});Ext.create("Ext.Panel",{renderTo:"buildContainer",height:720,layout:"border",autoScroll:!0,
items:[j,l]});Ext.Ajax.request({url:"/getHgStatus",method:"get",timeout:2E4,callback:function(a,c,b){a=b.responseText;c?window.hgStatus=JSON.parse(a):Ext.Msg.alert("错误","无法获取hg status信息.");if(!window.USER_HAD_INPUT){c=q.getRootNode();a=[];for(file in window.hgStatus)if(Object.prototype.hasOwnProperty.call(window.hgStatus,file)){for(var b=file.split("/"),e,d=c;d&&!(e=b.shift(),d.expand(),d=d.findChild("text",e,!1),!d||d.isLeaf()););d&&(d.set("checked",!0),a.push({Name:d.get("text"),LastModified:d.get("LastModified"),
Path:file,Status:window.hgStatus[file]}))}g.add(a);i.selectAll()}}})});
